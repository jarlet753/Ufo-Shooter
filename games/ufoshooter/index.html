<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ufo Shooter</title>
  <style>
    canvas {
      background-color: brown;
    }
    body {
      margin: 0;
      background-color: blue;
    }
    footer {
      height: 10px;
      background-color: black;
      margin: 0;
    }
     #upBtn {
    position: fixed;
    bottom: 100px;
    left: 20px;
    font-size: 2rem;
    z-index: 1000;
  }
  </style>
  <script>
    // Globale Variablen
    let rocket;
    let ctx;
    let backgroundImage;
    let ufos = [];
    let guns = [];
    let score = 0;
    let cooldown = 0;

    let KEY_SPACE = false;
    let KEY_UP = false;
    let KEY_DOWN = false;

    // Debug-Modus
    (function () {
      const params = new URLSearchParams(window.location.search);
      if (params.get("debug") === "true") {
        localStorage.setItem("debug", "true");
        alert("Debug = true");
      } else {
        localStorage.setItem("debug", "false");
        alert("Debug = false");
      }
    })();

    // Fehlerbehandlung
    window.onerror = function (message, source, lineno, colno, error) {
      if (localStorage.getItem("debug") === "true") {
        alert(
          message +
            "\n\n" +
            "URL: " +
            source +
            "\n" +
            "Line: " +
            lineno +
            "/" +
            colno +
            "\n\n" +
            "Stacktrace: " +
            (error && error.stack ? error.stack : "nicht verfügbar")
        );
      }
    };


    // Initialisierung nach Seitenladevorgang
    function startGame() {
      const canvas = document.getElementById("gamescreen");
      ctx = canvas.getContext("2d");

      // Rocket & Background
      backgroundImage = new Image();
      backgroundImage.src = "../../img/background.png";

      rocket = {
        x: 0,
        y: 0,
        width: 128,
        height: 74,
        src: "../../img/rocket.png",
        img: new Image(),
      };
      rocket.img.src = rocket.src;

      // Touch-Unterstützung
      const upBtn = document.getElementById("upBtn");
      upBtn.addEventListener("touchstart", () => (KEY_UP = true));
      upBtn.addEventListener("touchend", () => (KEY_UP = false));
      setInterval(debugUpdate, 1000/100);
      spawnUfoLoop();
      setInterval(update, 1000 / 30);
      requestAnimationFrame(draw);
    }

    // Tasteneingaben
    document.onkeydown = function (e) {
      e.preventDefault();
      if (e.keyCode === 192) KEY_SPACE = true;
      if (e.keyCode === 87) KEY_UP = true;
      if (e.keyCode === 83) KEY_DOWN = true;
    };

    document.onkeyup = function (e) {
      if (e.keyCode === 192) KEY_SPACE = false;
      if (e.keyCode === 87) KEY_UP = false;
      if (e.keyCode === 83) KEY_DOWN = false;
    };

    // UFO-Spawning-Loop
    let ufoSpawnDelay = 2000;
    const minSpawnDelay = 100;
    const spawnAcceleration = 10;

    function spawnUfoLoop() {
      createUfos();
      ufoSpawnDelay = Math.max(minSpawnDelay, ufoSpawnDelay - spawnAcceleration);
      setTimeout(spawnUfoLoop, ufoSpawnDelay);
    }

    // UFO erzeugen
    function getRandomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function createUfos() {
      let ufo = {
        x: 1700,
        y: getRandomInt(41, 959),
        width: 64,
        height: 41,
        speed: getRandomInt(7, 10),
        src: "../../img/ufo.png",
        img: new Image(),
      };
      ufo.img.src = ufo.src;
      ufos.push(ufo);
    }

    // Schuss abfeuern
    function shoot() {
      let shoot = {
        x: rocket.x + rocket.width,
        y: rocket.y + rocket.height / 2 - 15,
        width: 30,
        height: 30,
        src: "../../img/kugel.png",
        img: new Image(),
      };
      shoot.img.src = shoot.src;
      guns.push(shoot);
    }

    // Spiellogik-Update
    function update() {
      cooldown -= 1000 / 30;

      if (KEY_UP) rocket.y -= 5;
      if (KEY_DOWN) rocket.y += 5;

      if (rocket.y < 0) rocket.y = 0;
      if (rocket.y + rocket.height > 1000) rocket.y = 1000 - rocket.height;

      if (KEY_SPACE && cooldown <= 0) {
        KEY_SPACE = false;
        cooldown = 500;
        shoot();
      }

      // UFO-Bewegung und Kollision
      ufos = ufos.filter((ufo) => {
        ufo.x -= ufo.speed;
        const collision =
          rocket.x + rocket.width > ufo.x &&
          rocket.x < ufo.x + ufo.width &&
          rocket.y < ufo.y + ufo.height &&
          rocket.y + rocket.height > ufo.y;

        if (collision) {
          console.log("COLLISION");
          rocket.img.src = "../../img/explosion.png";
          return false; // UFO entfernen
        }

        return ufo.x > -50;
      });

      // Schuss-Bewegung & Kollision
      guns = guns.filter((shoot) => {
        shoot.x += 25;
        let hit = false;

        ufos = ufos.filter((ufo) => {
          const hitCheck =
            shoot.x + shoot.width > ufo.x &&
            shoot.x < ufo.x + ufo.width &&
            shoot.y < ufo.y + ufo.height &&
            shoot.y + shoot.height > ufo.y;

          if (hitCheck) {
            hit = true;
            score += 1;
            return false; // UFO entfernen
          }

          return true;
        });

        return !hit && shoot.x <= 1500;
      });

      document.getElementById("scoreboard").innerText = "Score: " + score;
    }

    // Zeichnen
    function draw() {
      ctx.drawImage(backgroundImage, 0, 0, 1500, 1000);
      ctx.drawImage(rocket.img, rocket.x, rocket.y, rocket.width, rocket.height);
      if (localStorage.getItem("debug") === "true") {
        ctx.font = "20px Arial";
        ctx.fillStyle = "yellow"
        ctx.fillText("Ufos: " + ufos.length, 10, 30);

      }
      ufos.forEach((ufo) =>
        ctx.drawImage(ufo.img, ufo.x, ufo.y, ufo.width, ufo.height)
      );

      guns.forEach((shoot) =>
        ctx.drawImage(shoot.img, shoot.x, shoot.y, shoot.width, shoot.height)
      );

      requestAnimationFrame(draw);
    }
    function debugUpdate(){
      
    }
  </script>
</head>
<body onload="startGame()">
  <header>
    <h1 id="scoreboard">Score: 0</h1>
  </header>
  <canvas id="gamescreen" width="1500" height="1000"></canvas>
  <button id="upBtn">Up</button>
  <footer></footer>
</body>
</html>
